<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Snippet — Code Snippet Manager</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .edit-page { max-width: 760px; margin: 28px auto; padding: 0 16px; }
    .edit-page-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
    .edit-page-header h2 { font-size: 1.4rem; font-weight: 700; }
    .form-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 28px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: .875rem; font-weight: 600; margin-bottom: 5px; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%; padding: 8px 10px;
      border: 1px solid var(--color-border); border-radius: 5px;
      font: inherit; font-size: .9rem;
      transition: border-color .15s, box-shadow .15s;
      background: var(--color-surface); color: var(--color-text);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none; border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(9,105,218,.15);
    }
    .form-group input.invalid,
    .form-group textarea.invalid { border-color: var(--color-danger); }
    .form-group .field-error { color: var(--color-danger); font-size: .8rem; margin-top: 3px; display: none; }
    .form-group .field-error.visible { display: block; }
    .form-group textarea#code-input {
      font-family: var(--font-mono); font-size: .85rem;
      min-height: 260px; resize: vertical;
      white-space: pre; overflow-x: auto;
    }
    .form-group textarea#description-input { min-height: 90px; resize: vertical; }
    .form-help { font-size: .78rem; color: var(--color-text-muted); margin-top: 4px; }
    .required { color: var(--color-danger); }
    .form-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 24px; }
    .form-banner { margin-bottom: 16px; padding: 10px 14px; border-radius: 5px; font-size: .875rem; }
    .form-banner.error { background: #ffebe9; color: var(--color-danger); border: 1px solid rgba(207,34,46,.25); }
    .form-banner[hidden] { display: none; }
    .back-link { display: inline-flex; align-items: center; gap: 4px; font-size: .875rem; margin-bottom: 20px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <h1 class="logo"><a href="/" style="color:inherit;text-decoration:none">Code Snippet Manager</a></h1>
    </div>
  </header>

  <main class="edit-page">
    <a href="/" class="back-link" id="back-link">← All Snippets</a>
    <div class="edit-page-header">
      <h2 id="page-title">New Snippet</h2>
    </div>

    <div class="form-card">
      <div class="form-banner error" id="form-error" hidden role="alert"></div>

      <form id="snippet-form" novalidate>
        <div class="form-group">
          <label for="title-input">Title <span class="required" aria-hidden="true">*</span></label>
          <input
            type="text"
            id="title-input"
            name="title"
            placeholder="e.g. Debounce function"
            autocomplete="off"
            aria-required="true"
          >
          <p class="field-error" id="title-error">Title is required.</p>
        </div>

        <div class="form-group">
          <label for="language-input">Language</label>
          <select id="language-input" name="language">
            <option value="">— Select language —</option>
            <option value="bash">Bash</option>
            <option value="c">C</option>
            <option value="cpp">C++</option>
            <option value="css">CSS</option>
            <option value="go">Go</option>
            <option value="html">HTML</option>
            <option value="java">Java</option>
            <option value="javascript">JavaScript</option>
            <option value="json">JSON</option>
            <option value="kotlin">Kotlin</option>
            <option value="markdown">Markdown</option>
            <option value="php">PHP</option>
            <option value="python">Python</option>
            <option value="ruby">Ruby</option>
            <option value="rust">Rust</option>
            <option value="scala">Scala</option>
            <option value="shell">Shell</option>
            <option value="sql">SQL</option>
            <option value="swift">Swift</option>
            <option value="toml">TOML</option>
            <option value="typescript">TypeScript</option>
            <option value="xml">XML</option>
            <option value="yaml">YAML</option>
          </select>
        </div>

        <div class="form-group">
          <label for="code-input">Code <span class="required" aria-hidden="true">*</span></label>
          <textarea
            id="code-input"
            name="code"
            placeholder="Paste your code here…"
            spellcheck="false"
            aria-required="true"
          ></textarea>
          <p class="field-error" id="code-error">Code is required.</p>
          <p class="form-help">Tab key inserts a tab character.</p>
        </div>

        <div class="form-group">
          <label for="description-input">Description</label>
          <textarea
            id="description-input"
            name="description"
            placeholder="What does this snippet do? (optional)"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="tags-input">Tags</label>
          <input
            type="text"
            id="tags-input"
            name="tags"
            placeholder="e.g. utility, async, array"
          >
          <p class="form-help">Comma-separated list of tags.</p>
        </div>

        <div class="form-actions">
          <a href="/" class="btn-secondary" id="cancel-btn">Cancel</a>
          <button type="submit" class="btn-primary" id="submit-btn">Save Snippet</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    // ── Determine mode (create vs edit) based on ?id= URL param ───────────────
    const params = new URLSearchParams(location.search);
    const editId = params.get('id');
    const isEdit = Boolean(editId);

    const pageTitle   = document.getElementById('page-title');
    const submitBtn   = document.getElementById('submit-btn');
    const backLink    = document.getElementById('back-link');
    const cancelBtn   = document.getElementById('cancel-btn');
    const formError   = document.getElementById('form-error');
    const form        = document.getElementById('snippet-form');

    const titleInput  = document.getElementById('title-input');
    const langInput   = document.getElementById('language-input');
    const codeInput   = document.getElementById('code-input');
    const descInput   = document.getElementById('description-input');
    const tagsInput   = document.getElementById('tags-input');

    const titleError  = document.getElementById('title-error');
    const codeError   = document.getElementById('code-error');

    if (isEdit) {
      document.title = 'Edit Snippet — Code Snippet Manager';
      pageTitle.textContent = 'Edit Snippet';
      submitBtn.textContent = 'Update Snippet';
      backLink.href = `snippet.html?id=${encodeURIComponent(editId)}`;
      cancelBtn.href = `snippet.html?id=${encodeURIComponent(editId)}`;
      loadSnippet(editId);
    }

    // ── Load existing snippet for editing ──────────────────────────────────────
    async function loadSnippet(id) {
      submitBtn.disabled = true;
      try {
        const res = await fetch(`/api/snippets/${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const s = await res.json();
        titleInput.value       = s.title || '';
        langInput.value        = s.language || '';
        codeInput.value        = s.code || '';
        descInput.value        = s.description || '';
        tagsInput.value        = (s.tags || []).join(', ');
      } catch (err) {
        showBanner('Failed to load snippet: ' + err.message);
      } finally {
        submitBtn.disabled = false;
      }
    }

    // ── Tab key support in code textarea ──────────────────────────────────────
    codeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = codeInput.selectionStart;
        const end   = codeInput.selectionEnd;
        codeInput.value = codeInput.value.substring(0, start) + '\t' + codeInput.value.substring(end);
        codeInput.selectionStart = codeInput.selectionEnd = start + 1;
      }
    });

    // ── Validation ─────────────────────────────────────────────────────────────
    function validateForm() {
      let valid = true;
      if (!titleInput.value.trim()) {
        titleInput.classList.add('invalid');
        titleError.classList.add('visible');
        valid = false;
      } else {
        titleInput.classList.remove('invalid');
        titleError.classList.remove('visible');
      }
      if (!codeInput.value.trim()) {
        codeInput.classList.add('invalid');
        codeError.classList.add('visible');
        valid = false;
      } else {
        codeInput.classList.remove('invalid');
        codeError.classList.remove('visible');
      }
      return valid;
    }

    // Clear invalid state on input
    titleInput.addEventListener('input', () => {
      titleInput.classList.remove('invalid');
      titleError.classList.remove('visible');
    });
    codeInput.addEventListener('input', () => {
      codeInput.classList.remove('invalid');
      codeError.classList.remove('visible');
    });

    function showBanner(msg) {
      formError.textContent = msg;
      formError.removeAttribute('hidden');
    }

    // ── Submit ─────────────────────────────────────────────────────────────────
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.setAttribute('hidden', '');

      if (!validateForm()) {
        // Focus first invalid field
        const firstInvalid = form.querySelector('.invalid');
        if (firstInvalid) firstInvalid.focus();
        return;
      }

      const rawTags = tagsInput.value.trim();
      const tags = rawTags
        ? rawTags.split(',').map(t => t.trim()).filter(Boolean)
        : [];

      const payload = {
        title:       titleInput.value.trim(),
        language:    langInput.value || '',
        code:        codeInput.value,
        description: descInput.value.trim() || undefined,
        tags:        tags.length ? tags : undefined,
      };

      submitBtn.disabled = true;
      submitBtn.textContent = isEdit ? 'Saving…' : 'Creating…';

      try {
        const url    = isEdit ? `/api/snippets/${encodeURIComponent(editId)}` : '/api/snippets';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error(body.error || `HTTP ${res.status}`);
        }

        const saved = await res.json();
        location.href = `snippet.html?id=${encodeURIComponent(saved.id)}`;
      } catch (err) {
        showBanner((isEdit ? 'Update' : 'Create') + ' failed: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = isEdit ? 'Update Snippet' : 'Save Snippet';
      }
    });
  </script>
</body>
</html>
