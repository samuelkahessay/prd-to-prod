#
# PR Reviewer — Automated review for [Pipeline] pull requests.
#
# This is a standard GitHub Actions workflow (not an agentic .md workflow)
# so that it always uses GITHUB_TOKEN (github-actions[bot] identity).
# This ensures a different identity from the GitHub App that creates PRs,
# avoiding GitHub's self-approval restriction.
#

name: "PR Reviewer"

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: read

concurrency:
  group: "pr-reviewer-${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    # Only review [Pipeline] PRs, skip if PR is from a fork
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (startsWith(github.event.pull_request.title, '[Pipeline]') &&
       github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          echo "number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"

          # Fetch PR metadata
          gh pr view "$PR_NUMBER" --json title,body,baseRefName,headRefName,additions,deletions,changedFiles \
            > pr_metadata.json

          PR_TITLE=$(jq -r '.title' pr_metadata.json)
          PR_BODY=$(jq -r '.body' pr_metadata.json)
          echo "title=${PR_TITLE}" >> "$GITHUB_OUTPUT"

          # Extract linked issue number from "Closes #N" pattern
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oP 'Closes #\K[0-9]+' | head -1 || true)
          echo "issue_number=${ISSUE_NUMBER}" >> "$GITHUB_OUTPUT"

          # Fetch the diff
          gh pr diff "$PR_NUMBER" > pr_diff.txt

          # Truncate diff if too large (keep first 12000 lines)
          if [ "$(wc -l < pr_diff.txt)" -gt 12000 ]; then
            head -n 12000 pr_diff.txt > pr_diff_truncated.txt
            echo -e "\n\n[... diff truncated — $(wc -l < pr_diff.txt) total lines ...]" >> pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
          fi

      - name: Fetch linked issue
        id: issue
        if: steps.pr.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.pr.outputs.issue_number }}"
          gh issue view "$ISSUE_NUMBER" --json title,body > issue_metadata.json
          ISSUE_BODY=$(jq -r '.body' issue_metadata.json)
          echo "has_issue=true" >> "$GITHUB_OUTPUT"

          # Extract acceptance criteria section
          ACCEPTANCE_CRITERIA=$(echo "$ISSUE_BODY" | sed -n '/## Acceptance Criteria/,/^## /p' | head -n -1)
          if [ -z "$ACCEPTANCE_CRITERIA" ]; then
            ACCEPTANCE_CRITERIA="No acceptance criteria section found in the issue."
          fi

          # Write to file to avoid quoting issues
          echo "$ACCEPTANCE_CRITERIA" > acceptance_criteria.txt
          echo "$ISSUE_BODY" > issue_body.txt

      - name: Check CI status
        id: ci
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Get check runs status (exclude this workflow)
          CHECKS_JSON=$(gh pr checks "$PR_NUMBER" --json name,state,bucket 2>/dev/null || echo "[]")

          # Determine overall CI status
          FAILED_CHECKS=$(echo "$CHECKS_JSON" | jq -r '[.[] | select(.name != "PR Reviewer" and .bucket == "fail")] | length')
          PENDING_CHECKS=$(echo "$CHECKS_JSON" | jq -r '[.[] | select(.name != "PR Reviewer" and .bucket == "pending")] | length')

          if [ "$FAILED_CHECKS" -gt 0 ]; then
            echo "status=failing" >> "$GITHUB_OUTPUT"
            echo "summary=CI has $FAILED_CHECKS failing check(s)" >> "$GITHUB_OUTPUT"
          elif [ "$PENDING_CHECKS" -gt 0 ]; then
            echo "status=pending" >> "$GITHUB_OUTPUT"
            echo "summary=CI has $PENDING_CHECKS pending check(s)" >> "$GITHUB_OUTPUT"
          else
            echo "status=passing" >> "$GITHUB_OUTPUT"
            echo "summary=All CI checks pass" >> "$GITHUB_OUTPUT"
          fi

      - name: Read AGENTS.md
        id: agents
        run: |
          if [ -f AGENTS.md ]; then
            # Extract key sections for context
            head -200 AGENTS.md > agents_context.txt
          else
            echo "No AGENTS.md found." > agents_context.txt
          fi

      - name: Build review prompt
        id: prompt
        run: |
          cat > review_prompt.txt << 'PROMPT_HEADER'
          You are a senior code reviewer for an automated pipeline. Review this pull request and decide: APPROVE or REQUEST_CHANGES.

          ## Review Criteria

          1. **Acceptance Criteria**: Does the diff address ALL acceptance criteria from the linked issue? Each criterion must be met.
          2. **Correctness**: Are there obvious bugs, logic errors, or runtime failures?
          3. **Security**: Any injection vulnerabilities, exposed secrets, or unsafe operations?
          4. **Scope**: Does the PR stay within scope? Flag unrelated changes.
          5. **Code Quality**: Does the code follow the project's patterns (from AGENTS.md)?
          6. **Tests**: Are tests included where appropriate? Do they cover the acceptance criteria?

          ## Decision Rules

          - APPROVE if: all acceptance criteria are met, no obvious bugs or security issues, code is within scope
          - REQUEST_CHANGES if: any acceptance criteria are NOT met, there are bugs/security issues, or the PR is clearly out of scope
          - When CI is failing: always REQUEST_CHANGES with a note about CI failures
          - When CI is pending: you may still APPROVE if the code looks correct (CI will gate the merge)
          - Be pragmatic: minor style issues alone are NOT grounds for REQUEST_CHANGES

          ## Response Format

          You MUST respond with EXACTLY this format:

          DECISION: [APPROVE or REQUEST_CHANGES]

          SUMMARY: [1-2 sentence summary of your review]

          ISSUES:
          - [issue 1, if any]
          - [issue 2, if any]
          (or "None" if approving)

          PROMPT_HEADER

          echo "" >> review_prompt.txt
          echo "## PR: ${{ steps.pr.outputs.title }}" >> review_prompt.txt
          echo "" >> review_prompt.txt

          echo "## CI Status: ${{ steps.ci.outputs.summary }}" >> review_prompt.txt
          echo "" >> review_prompt.txt

          if [ -f acceptance_criteria.txt ]; then
            echo "## Linked Issue Acceptance Criteria" >> review_prompt.txt
            cat acceptance_criteria.txt >> review_prompt.txt
            echo "" >> review_prompt.txt
          fi

          if [ -f issue_body.txt ]; then
            echo "## Full Issue Description" >> review_prompt.txt
            cat issue_body.txt >> review_prompt.txt
            echo "" >> review_prompt.txt
          fi

          echo "## Project Guidelines (AGENTS.md excerpt)" >> review_prompt.txt
          cat agents_context.txt >> review_prompt.txt
          echo "" >> review_prompt.txt

          echo "## Diff" >> review_prompt.txt
          echo '```diff' >> review_prompt.txt
          cat pr_diff.txt >> review_prompt.txt
          echo '```' >> review_prompt.txt

      - name: Run AI review
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use GitHub Models via gh models run
          REVIEW_OUTPUT=$(gh models run gpt-4.1 < review_prompt.txt 2>&1) || {
            echo "::warning::AI review failed, falling back to basic review"
            # Fallback: approve if CI passes, request changes if CI fails
            if [ "${{ steps.ci.outputs.status }}" = "failing" ]; then
              REVIEW_OUTPUT="DECISION: REQUEST_CHANGES
          SUMMARY: CI checks are failing. Please fix CI failures before this PR can be approved.
          ISSUES:
          - CI is currently failing (${{ steps.ci.outputs.summary }})"
            else
              REVIEW_OUTPUT="DECISION: APPROVE
          SUMMARY: Automated review — CI checks are passing. AI review was unavailable.
          ISSUES:
          None"
            fi
          }

          # Write to file for parsing
          echo "$REVIEW_OUTPUT" > review_output.txt
          cat review_output.txt

          # Parse decision
          DECISION=$(grep -oP '^DECISION:\s*\K\S+' review_output.txt | head -1 || echo "REQUEST_CHANGES")
          SUMMARY=$(grep -oP '^SUMMARY:\s*\K.*' review_output.txt | head -1 || echo "Review completed.")
          echo "decision=${DECISION}" >> "$GITHUB_OUTPUT"
          echo "summary=${SUMMARY}" >> "$GITHUB_OUTPUT"

      - name: Submit review — APPROVE
        if: steps.review.outputs.decision == 'APPROVE'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Build review body
          REVIEW_BODY=$(cat << 'EOF'
          ## Pipeline Review — Approved

          **Decision**: APPROVE

          EOF
          )
          REVIEW_BODY+=$(cat review_output.txt | sed -n '/^SUMMARY:/,$ p')
          REVIEW_BODY+=$(cat << 'EOF'

          ---
          *This review was performed by Pipeline Reviewer (github-actions[bot]).*
          EOF
          )

          # Submit approval via GitHub API
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews" \
            -f event='APPROVE' \
            -f body="${REVIEW_BODY}"

          # If the PR is still a draft, mark it ready for review
          PR_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft -q '.isDraft')
          if [ "$PR_DRAFT" = "true" ]; then
            gh pr ready "$PR_NUMBER" || echo "::warning::Could not mark PR as ready"
          fi

          # Enable auto-merge
          gh pr merge "$PR_NUMBER" --auto --squash || echo "::warning::Could not enable auto-merge (may not be configured on repo)"

          echo "PR #${PR_NUMBER} approved and auto-merge enabled."

      - name: Submit review — REQUEST_CHANGES
        if: steps.review.outputs.decision != 'APPROVE'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          REVIEW_BODY=$(cat << 'EOF'
          ## Pipeline Review — Changes Requested

          **Decision**: REQUEST_CHANGES

          EOF
          )
          REVIEW_BODY+=$(cat review_output.txt | sed -n '/^SUMMARY:/,$ p')
          REVIEW_BODY+=$(cat << 'EOF'

          ---
          *This review was performed by Pipeline Reviewer (github-actions[bot]).
          repo-assist will automatically address this feedback on its next run.*
          EOF
          )

          # Submit change request via GitHub API
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews" \
            -f event='REQUEST_CHANGES' \
            -f body="${REVIEW_BODY}"

          echo "PR #${PR_NUMBER} — changes requested."
