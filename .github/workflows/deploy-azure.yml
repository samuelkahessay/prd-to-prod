#
# Deploy to Azure â€” Builds and deploys the app to Azure App Service on every
# push to main (i.e., after a PR merges).
#
# Flow:
#   1. Push lands on main (direct or via merged PR)
#   2. Restore, build, and publish the .NET app in Release configuration
#   3. Log in to Azure via service principal, then deploy the published output
#
# Prerequisites:
#   - AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID secrets
#   - Federated identity credential on the github-deploy-prd-to-prod service principal
#     (subject: repo:samuelkahessay/prd-to-prod:ref:refs/heads/main)
#
# Safety:
#   - Concurrency group ensures only one deploy runs at a time; newer pushes
#     cancel in-progress deploys (safe because we always deploy HEAD of main)
#

name: Deploy to Azure

on:
  workflow_call:
  workflow_dispatch:  # manual trigger for testing/debugging

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-azure
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - run: dotnet restore TicketDeflection.sln
      - run: dotnet build TicketDeflection.sln --no-restore -c Release
      - run: dotnet test TicketDeflection.sln --no-build -c Release --verbosity normal
      - run: dotnet publish TicketDeflection/TicketDeflection.csproj --no-build -c Release -o ./publish

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        run: |
          cd publish && zip -qr ../deploy.zip . && cd ..
          az webapp config appsettings set \
            --name prd-to-prod \
            --resource-group prd-to-prod-rg \
            --settings WEBSITE_RUN_FROM_PACKAGE=1 \
            --output none
          az webapp deploy \
            --name prd-to-prod \
            --resource-group prd-to-prod-rg \
            --src-path deploy.zip \
            --type zip \
            --clean true
