name: Auto-Dispatch Pipeline Issues

on:
  issues:
    types: [opened, reopened, labeled]

permissions:
  contents: read
  actions: write
  issues: write

# Collapse rapid issue creation (e.g., decomposer burst) to one dispatch.
concurrency:
  group: auto-dispatch-pipeline-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  dispatch:
    if: |
      !startsWith(github.event.issue.title, '[CI Incident]') &&
      github.event.issue.title != '[Pipeline] Status' &&
      !contains(github.event.issue.labels.*.name, 'report') &&
      contains(github.event.issue.labels.*.name, 'pipeline') &&
      (
        contains(github.event.issue.labels.*.name, 'bug') ||
        contains(github.event.issue.labels.*.name, 'docs') ||
        contains(github.event.issue.labels.*.name, 'feature') ||
        contains(github.event.issue.labels.*.name, 'infra') ||
        contains(github.event.issue.labels.*.name, 'test')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PIPELINE_HEALING_ENABLED: ${{ vars.PIPELINE_HEALING_ENABLED }}
    steps:
      - name: Checkout workflow helpers
        uses: actions/checkout@v4
        with:
          sparse-checkout: scripts/healing-control.sh
          sparse-checkout-cone-mode: false

      - name: Check healing pause switch
        id: healing
        run: |
          if scripts/healing-control.sh is-enabled; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "skip_reason=healing_paused" >> "$GITHUB_OUTPUT"
            echo "Autonomous healing is paused via PIPELINE_HEALING_ENABLED."
          fi

      - name: Debounce (let issue burst settle)
        if: steps.healing.outputs.skip != 'true'
        run: sleep 15

      - name: Skip when repo-assist already active
        if: steps.healing.outputs.skip != 'true'
        id: guard
        env:
          GH_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          ACTIVE_RUNS=$(gh run list --repo "$REPO" \
            --workflow repo-assist.lock.yml \
            --limit 20 \
            --json databaseId,status,url,createdAt \
            | jq '[.[] | select(.status == "in_progress" or .status == "queued")] | sort_by(.createdAt)')
          ACTIVE_COUNT=$(printf '%s' "$ACTIVE_RUNS" | jq 'length')
          BLOCKING_RUN_ID=$(printf '%s' "$ACTIVE_RUNS" | jq -r '.[0].databaseId // ""')
          BLOCKING_RUN_URL=$(printf '%s' "$ACTIVE_RUNS" | jq -r '.[0].url // ""')
          echo "blocking_run_id=${BLOCKING_RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "blocking_run_url=${BLOCKING_RUN_URL}" >> "$GITHUB_OUTPUT"
          if [ "$ACTIVE_COUNT" -gt 0 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "repo-assist already queued/running; skipping dispatch."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Record deferred dispatch marker
        if: steps.healing.outputs.skip != 'true' && steps.guard.outputs.skip == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          DISPATCH_WORKFLOW_RUN_ID: ${{ github.run_id }}
          BLOCKING_RUN_ID: ${{ steps.guard.outputs.blocking_run_id }}
          BLOCKING_RUN_URL: ${{ steps.guard.outputs.blocking_run_url }}
        run: |
          DEFERRED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BODY=$(printf '%s\n' \
            '<!-- self-healing-dispatch-deferred:v1' \
            'dispatch_workflow=Auto-Dispatch Pipeline Issues' \
            "dispatch_workflow_run_id=${DISPATCH_WORKFLOW_RUN_ID}" \
            "dispatch_workflow_run_url=https://github.com/${REPO}/actions/runs/${DISPATCH_WORKFLOW_RUN_ID}" \
            "blocking_repo_assist_run_id=${BLOCKING_RUN_ID}" \
            "blocking_repo_assist_run_url=${BLOCKING_RUN_URL}" \
            "deferred_at=${DEFERRED_AT}" \
            '-->' \
            '' \
            'Self-healing audit marker: dispatch deferred while repo-assist was already active.')
          gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "$BODY" >/dev/null || \
            echo "::warning::Could not record deferred dispatch marker on issue #${ISSUE_NUMBER}"

      - name: Dispatch repo-assist scheduled mode
        if: steps.healing.outputs.skip != 'true' && steps.guard.outputs.skip != 'true'
        id: dispatch_repo_assist
        env:
          GH_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          DISPATCHED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          gh workflow run repo-assist.lock.yml \
            --repo "$REPO"

          REPO_ASSIST_RUN_ID=""
          REPO_ASSIST_RUN_URL=""
          for attempt in $(seq 1 12); do
            RUN_JSON=$(gh run list --repo "$REPO" \
              --workflow repo-assist.lock.yml \
              --event workflow_dispatch \
              --limit 20 \
              --json databaseId,createdAt,url,displayTitle \
              | jq --arg dispatched_at "$DISPATCHED_AT" '[.[] | select(.displayTitle == "Pipeline Repo Assist" and .createdAt >= $dispatched_at)] | sort_by(.createdAt) | last // {}')
            REPO_ASSIST_RUN_ID=$(printf '%s' "$RUN_JSON" | jq -r '.databaseId // ""')
            REPO_ASSIST_RUN_URL=$(printf '%s' "$RUN_JSON" | jq -r '.url // ""')
            if [ -n "$REPO_ASSIST_RUN_ID" ]; then
              break
            fi
            sleep 5
          done

          echo "dispatched_at=${DISPATCHED_AT}" >> "$GITHUB_OUTPUT"
          echo "repo_assist_run_id=${REPO_ASSIST_RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "repo_assist_run_url=${REPO_ASSIST_RUN_URL}" >> "$GITHUB_OUTPUT"

      - name: Record dispatch marker
        if: steps.healing.outputs.skip != 'true' && steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          DISPATCH_WORKFLOW_RUN_ID: ${{ github.run_id }}
          REPO_ASSIST_RUN_ID: ${{ steps.dispatch_repo_assist.outputs.repo_assist_run_id }}
          REPO_ASSIST_RUN_URL: ${{ steps.dispatch_repo_assist.outputs.repo_assist_run_url }}
          DISPATCHED_AT: ${{ steps.dispatch_repo_assist.outputs.dispatched_at }}
        run: |
          BODY=$(printf '%s\n' \
            '<!-- self-healing-dispatch:v1' \
            'dispatch_workflow=Auto-Dispatch Pipeline Issues' \
            "dispatch_workflow_run_id=${DISPATCH_WORKFLOW_RUN_ID}" \
            "dispatch_workflow_run_url=https://github.com/${REPO}/actions/runs/${DISPATCH_WORKFLOW_RUN_ID}" \
            "repo_assist_run_id=${REPO_ASSIST_RUN_ID}" \
            "repo_assist_run_url=${REPO_ASSIST_RUN_URL}" \
            "dispatched_at=${DISPATCHED_AT}" \
            '-->' \
            '' \
            'Self-healing audit marker: repo-assist dispatched.')
          gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "$BODY" >/dev/null || \
            echo "::warning::Could not record dispatch marker on issue #${ISSUE_NUMBER}"
