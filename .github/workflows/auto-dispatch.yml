name: Auto-Dispatch Pipeline Issues

on:
  issues:
    types: [opened, reopened, labeled]

# Collapse rapid issue creation (e.g., decomposer burst) to one dispatch.
concurrency:
  group: auto-dispatch-pipeline-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  dispatch:
    if: |
      !startsWith(github.event.issue.title, '[CI Incident]') &&
      (
        contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.issue.author_association) ||
        github.event.issue.user.login == 'github-actions[bot]'
      ) &&
      contains(github.event.issue.labels.*.name, 'pipeline')
    runs-on: ubuntu-latest
    steps:
      - name: Debounce (let issue burst settle)
        run: sleep 15

      - name: Skip when repo-assist already active
        id: guard
        env:
          GH_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          IN_PROGRESS=$(gh run list --repo "$REPO" \
            --workflow repo-assist.lock.yml \
            --status in_progress \
            --json databaseId \
            --jq 'length')
          QUEUED=$(gh run list --repo "$REPO" \
            --workflow repo-assist.lock.yml \
            --status queued \
            --json databaseId \
            --jq 'length')
          if [ "$IN_PROGRESS" -gt 0 ] || [ "$QUEUED" -gt 0 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "repo-assist already queued/running; skipping dispatch."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch repo-assist scheduled mode
        if: steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
        run: |
          gh workflow run repo-assist.lock.yml \
            --repo ${{ github.repository }}
